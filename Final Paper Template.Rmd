---
title: "Final Paper"
author: "STOR 320.01 Group 4"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(caret)
library(collapsibleTree)
library(knitr)
library(kableExtra)
library(ggplot2)
library(fmsb)
library(dplyr)
library(stringr)
library(sf)
library(patchwork)
library(purrr)
library(plotly)
library(gridExtra)
library(ggridges)
#Put Necessary Libraries Here
```

```{r, echo=F, }
air <- read.csv("Air.csv")
air <- air[, -1] %>%
  replace(is.na(.), 0) %>%
  mutate(Instances = as.numeric(gsub(",", "", Instances)))

water <- read.csv("Water.csv")
water <- water[, -1] %>%
  replace(is.na(.), 0) %>%
  mutate(Instances = as.numeric(gsub(",", "", Instances)))

land <- read.csv("Land.csv")
land <- land[, -1] %>%
  replace(is.na(.), 0) %>%
  mutate(Instances = as.numeric(gsub(",", "", Instances)))

built <- read.csv("Built.csv")
built <- built[, -1] %>%
  replace(is.na(.), 0) %>%
  mutate(Instances = as.numeric(gsub(",", "", Instances)))

sociodemo <- read.csv("Sociodemo.csv")
sociodemo <- sociodemo[, -1] %>%
  replace(is.na(.), 0) %>%
  mutate(Instances = as.numeric(gsub(",", "", Instances)))

airALL <- read.csv("AirAll.csv")
airALL <- airALL[, -1] %>%
  replace(is.na(.), 0)

waterALL <- read.csv("WaterAll.csv")
waterALL <- waterALL[, -1] %>%
  replace(is.na(.), 0)

landALL <- read.csv("LandAll.csv")
landALL <- landALL[, -1] %>%
  replace(is.na(.), 0)

builtALL <- read.csv("BuiltAll.csv")
builtALL <- builtALL[, -1] %>%
  replace(is.na(.), 0)

sociodemoALL <- read.csv("SociodemoAll.csv")
sociodemoALL <- sociodemoALL[, -1] %>%
  replace(is.na(.), 0)

# Air 
air_vars_all <- airALL[, !names(airALL) %in% c("County")]

standardized_air_all <- scale(air_vars_all)

weights <- rep(1/84, 84)

EQI <- rowSums(standardized_air_all * weights)

min_EQI_air_all <- min(EQI)
max_EQI_air_all <- max(EQI)

# Water
water_vars_all <- waterALL[, !names(waterALL) %in% c("County")]

standardized_water_all <- scale(water_vars_all)

weights <- rep(1/79, 79)

EQI <- rowSums(standardized_water_all * weights)

min_EQI_water_all <- min(EQI)
max_EQI_water_all <- max(EQI)

# Land
land_vars_all <- landALL[, !names(landALL) %in% c("County")]

standardized_land_all <- scale(land_vars_all)

weights <- rep(1/26, 26)

EQI <- rowSums(standardized_land_all * weights)

min_EQI_land_all <- min(EQI)
max_EQI_land_all <- max(EQI)

# Built
built_vars_all <- builtALL[, !names(builtALL) %in% c("County")]

standardized_built_all <- scale(built_vars_all)

weights <- rep(1/14, 14)

EQI <- rowSums(standardized_built_all * weights)

min_EQI_built_all <- min(EQI)
max_EQI_built_all <- max(EQI)

# Sociodemo
sociodemo_vars_all <- sociodemoALL[, !names(sociodemoALL) %in% c("County")]

standardized_sociodemo_all <- scale(sociodemo_vars_all)

weights <- rep(1/12, 12)

EQI <- rowSums(standardized_sociodemo_all * weights)

min_EQI_sociodemo_all <- min(EQI)
max_EQI_sociodemo_all <- max(EQI)

air_vars <- air[, !names(air) %in% c("County", "Instances", "Instance_Rate")]

standardized_air <- scale(air_vars)

weights <- rep(1/84, 84)

EQI <- rowSums(standardized_air * weights)

min_EQI <- min_EQI_air_all
max_EQI <- max_EQI_air_all
normalized_EQI <- (EQI - min_EQI) / (max_EQI - min_EQI) 

air$EQI <- normalized_EQI

summary_statistic <- mean(normalized_EQI)

water_vars <- water[, !names(water) %in% c("County", "Instances", "Instance_Rate")]

standardized_water <- scale(water_vars) %>%
  replace(is.na(.), 0)

weights <- rep(1/79, 79)

EQI <- rowSums(standardized_water * weights)

min_EQI <- min_EQI_water_all
max_EQI <- max_EQI_water_all
normalized_EQI <- (EQI - min_EQI) / (max_EQI - min_EQI)

water$EQI <- normalized_EQI

summary_statistic <- mean(normalized_EQI)

land_vars <- land[, !names(land) %in% c("County", "Instances", "Instance_Rate")]

standardized_land <- scale(land_vars) %>%
  replace(is.na(.), 0)

weights <- rep(1/26, 26)

EQI <- rowSums(standardized_land * weights)

min_EQI <- min_EQI_land_all
max_EQI <- max_EQI_land_all
normalized_EQI <- (EQI - min_EQI) / (max_EQI - min_EQI)

land$EQI <- normalized_EQI

summary_statistic <- mean(normalized_EQI)

built_vars <- built[, !names(built) %in% c("County", "Instances", "Instance_Rate")]

standardized_built <- scale(built_vars) %>%
  replace(is.na(.), 0)

weights <- rep(1/14, 14)

EQI <- rowSums(standardized_built * weights)

min_EQI <- min_EQI_built_all
max_EQI <- max_EQI_built_all
normalized_EQI <- (EQI - min_EQI) / (max_EQI - min_EQI)

built$EQI <- normalized_EQI

summary_statistic <- mean(normalized_EQI)

sociodemo_vars <- sociodemo[, !names(sociodemo) %in% c("County", "Instances", "Instance_Rate")]

standardized_sociodemo <- scale(sociodemo_vars) %>%
  replace(is.na(.), 0)

weights <- rep(1/12, 12)

EQI <- rowSums(standardized_sociodemo * weights)

min_EQI <- min_EQI_sociodemo_all
max_EQI <- max_EQI_sociodemo_all
normalized_EQI <- (EQI - min_EQI) / (max_EQI - min_EQI)

sociodemo$EQI <- normalized_EQI

summary_statistic <- mean(normalized_EQI)

combined_EQIs <- bind_cols(
  County = air$County,
  Air_EQI = air$EQI,
  Water_EQI = water$EQI,
  Land_EQI = land$EQI,
  Built_EQI = built$EQI,
  Sociodemo_EQI = sociodemo$EQI
)

combined_EQIs$Instances <- air$Instances
combined_EQIs$Instance_Rate <- air$Instance_Rate
```


# INTRODUCTION

In the realm of cancer research, the fusion of data analysis and environmental science unveils a landscape ripe with possibilities for innovation and discovery. As we embark on this journey, two compelling questions emerge, each poised to unravel critical insights that could revolutionize cancer prevention strategies and public health initiatives.

The first question delves into the nuanced interplay between environmental quality domains and cancer incidence rates. Specifically, we aim to discern whether certain domains within the Environmental Quality Index (EQI) dataset exhibit a heightened propensity for predicting cancer incidence. This inquiry transcends mere academic curiosity, offering tangible benefits for policymakers and researchers alike. By pinpointing domains with significant predictive power, stakeholders can tailor interventions to target specific environmental factors, optimizing resource allocation and amplifying the efficacy of public health campaigns. Moreover, unraveling the intricate relationship between environmental quality domains and cancer incidence holds the potential to unearth novel insights into the etiology of cancer, paving the way for more nuanced prevention strategies and interventions.

The second question ventures into the realm of chemical hazards and their impact on cancer incidence rates. Here, our aim is to discern whether certain hazardous chemicals or variables within the EQI dataset wield a disproportionate influence on cancer rates. Beyond the realms of academia, this question resonates deeply with policymakers, regulatory agencies, and public health advocates. By identifying chemicals with significant predictive power, stakeholders can prioritize regulatory efforts, implement targeted monitoring programs, and devise evidence-based interventions aimed at reducing exposure and mitigating risk. Furthermore, understanding the differential impact of various chemicals on cancer incidence not only informs regulatory priorities but also shapes public perceptions of risk, driving advocacy efforts and fostering community engagement in environmental health issues.

The relevance of these questions extends far beyond the confines of academic inquiry. By unraveling the complex interplay between environmental quality, chemical exposures, and cancer incidence, this research has the potential to catalyze transformative change on a global scale. From guiding policy decisions to empowering communities with actionable insights, the findings gleaned from these investigations hold the key to unlocking a future where cancer incidence is mitigated, and public health is safeguarded. As we embark on this quest for knowledge, the promise of innovative solutions and tangible impact beckons, inviting stakeholders from diverse backgrounds to join hands in the pursuit of a healthier, more sustainable future.

# DATA

The data utilized in this analysis derives its depth from two primary sources: the Environmental Protection Agency (EPA) and the North Carolina Department of Health and Human Services (NCDHHS) Division of Public Health. These datasets provide a robust foundation for exploring the intricate relationship between environmental quality and cancer incidence rates within the context of North Carolina during the year 2013.

From the Environmental Protection Agency, a comprehensive array of data was obtained, spanning various domains critical for assessing environmental quality. These domains encompass a wide range of factors that collectively contribute to shaping the environmental landscape of North Carolina's counties. For instance, the air domain offers insights into criteria air pollutants and hazardous air pollutants (HAPs), shedding light on the quality of the air breathed by residents. Similarly, the water domain delves into metrics related to general water contamination and chemical contamination, providing crucial information on the safety of water sources. Moreover, the land domain explores factors such as agricultural environment, pesticides, and soil contaminants, offering insights into the health risks associated with land use practices. Complementing these domains, the built-environment domain assesses the impact of factors like traffic-related environment and public housing conditions on public health outcomes, while the sociodemographic domain evaluates socioeconomic factors and crime rates, illuminating the broader societal context in which environmental health disparities exist.

| Domain             | Variables                   | Description                                      |
|--------------------|-----------------------------|--------------------------------------------------|
| Air                | Criteria Air Pollutants    | Metrics related to air quality and pollutants   |
|                    | Hazardous Air Pollutants   | Measures of hazardous air pollutants           |
| Water              | General Water Contamination | Indicators of water quality and contamination  |
|                    | Chemical Contamination      | Metrics assessing chemical contamination of water |
| Land               | Agricultural Environment    | Factors related to land quality and agriculture |
|                    | Pesticides                 | Presence and impact of pesticides on the land  |
| Built-Environment | Traffic-Related Environment | Characteristics of the built environment and traffic |
|                    | Public Housing Conditions   | Conditions of public housing in different areas |
| Sociodemographic   | Socioeconomic Factors       | Indicators of socioeconomic status and disparities |
|                    | Crime Rates                 | Rates of crime within communities               |

In addition to the EPA data, the NCDHHS Division of Public Health contributes crucial information on cancer instance rates across North Carolina's counties. This dataset, sourced from the National Center for Health Statistics, provides invaluable insights into the prevalence and distribution of cancer within the state. With each observation representing a distinct county, this dataset enables a granular analysis of cancer incidence rates, allowing researchers to explore geographical variations and identify potential hotspots for targeted interventions.

The dataset comprises 100 observations, corresponding to the number of counties in North Carolina. This comprehensive coverage ensures that the analysis captures the full geographic diversity of the state, facilitating robust comparisons and meaningful insights into the factors influencing cancer incidence rates across different regions. By leveraging this rich dataset, researchers and policymakers can gain actionable insights into the specific environmental factors driving variations in cancer incidence rates, paving the way for evidence-based interventions and policy decisions aimed at reducing the burden of cancer and improving public health outcomes statewide.

```{r, echo=F, message=FALSE, warning=FALSE, fig.align='center', fig.height=3}
nc_counties <- st_read("/Users/trentonmills18/Desktop/STOR 320/Final Project/nc_counties", quiet=TRUE)
merged_data <- merge(nc_counties, combined_EQIs, by = "County")

ggplot() +
  geom_sf(data = merged_data, aes(fill = Instance_Rate), color = NA) + 
  scale_fill_gradient(low = "lightblue", high = "darkblue", name = "Instance Rate", limits = c(225, 650)) +
  labs(title = "Cancer Instance Rates in North Carolina", 
       caption = "Rates are per 100,000") +
  theme_minimal() +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank())
```

This detailed description of the data used underscores the richness and complexity of the datasets sourced from the EPA and NCDHHS Division of Public Health. Through the exploration of environmental quality domains and cancer incidence rates, this analysis aims to unravel actionable insights to inform targeted interventions and policy decisions, ultimately contributing to improved public health outcomes and the mitigation of cancer burdens across North Carolina.

# RESULTS

### Q1: Identifying Domains with Predictive Power for Cancer Incidence Rates

To address the first question regarding the identification of domains within the EQI dataset that have a higher propensity for predicting cancer incidence rates, a systematic approach was undertaken. Initially, each domain—air, water, land, built environment, and sociodemographic factors—was processed individually to calculate an Environmental Quality Index (EQI) for each county. This EQI served as a composite measure of environmental quality within each domain. By standardizing against all the counties in the United States and weighting the relevant variables within each domain, a normalized EQI was derived.

```{r, echo=F}
combined_EQIs <- combined_EQIs[1:10, c(1,2,3,4,5,6,8)]

html_table <- knitr::kable(combined_EQIs, "html") %>%
  kableExtra::kable_styling()

html_table
```

```{r, echo=F, result=F, fig.width=10, fig.height=4, fig.align='center'}
common_limits <- range(c(merged_data$Air_EQI, 
                         merged_data$Water_EQI, 
                          merged_data$Land_EQI, 
                          merged_data$SocioDemo_EQI, 
                          merged_data$Built_EQI))

# Combine plots into a single image
combined_plot <- ggplot() +
  geom_sf(data = merged_data, aes(fill = Air_EQI), color = NA) + 
  scale_fill_gradient(low = "lightblue", high = "darkblue", name = "Air EQI", limits = common_limits) +
  labs(title = "Air EQI") +
  theme_minimal() +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank()) +

  ggplot() +
  geom_sf(data = merged_data, aes(fill = Water_EQI), color = NA) + 
  scale_fill_gradient(low = "lightblue", high = "darkblue", name = "Air EQI", limits = common_limits) +
  labs(title = "Water EQI") +
  theme_minimal() +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank()) +
  plot_layout(guides = "collect") +  # Collect legends
  
  ggplot() +
  geom_sf(data = merged_data, aes(fill = Land_EQI), color = NA) + 
  scale_fill_gradient(low = "lightblue", high = "darkblue", name = "Air EQI", limits = common_limits) +
  labs(title = "Land EQI") +
  theme_minimal() +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank()) +

  ggplot() +
  geom_sf(data = merged_data, aes(fill = Built_EQI), color = NA) + 
  scale_fill_gradient(low = "lightblue", high = "darkblue", name = "Air EQI", limits = common_limits) +
  labs(title = "Built EQI") +
  theme_minimal() +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank()) +

  ggplot() +
  geom_sf(data = merged_data, aes(fill = Sociodemo_EQI), color = NA) + 
  scale_fill_gradient(low = "lightblue", high = "darkblue", name = "Air EQI", limits = common_limits) +
  labs(title = "Sociodemo EQI") +
  theme_minimal() +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank())

# Output the combined plot
combined_plot + 
  plot_annotation(title = "EQI Heat Maps of NC Counties") +
  plot_layout(guides = 'collect')
```

Cross-validation using linear regression models was then conducted for each domain's EQI against cancer incidence rates. The Root Mean Square Error (RMSE) and Mean Absolute Error (MAE) were chosen as evaluation metrics to assess the predictive performance of environmental domains in predicting cancer incidence rates. RMSE quantifies the average magnitude of errors between predicted and actual values while considering the squared differences, making it sensitive to outliers. MAE, on the other hand, measures the average magnitude of errors without considering their direction, providing a straightforward interpretation of prediction accuracy. By using both metrics in cross-validation with 25 folds and 10 repeats, the analysis aims to provide a robust evaluation of the models' accuracy and precision. This approach ensures thorough validation and reduces bias, leading to more reliable insights into the predictive power of environmental domains in assessing cancer risk.

```{r, echo=F, fig.align='center'}
# Create a data frame for RMSE and MAE
results_df <- data.frame(
  Domain = c("Air", "Water", "Land", "Built", "Sociodemo"),
  RMSE = c(46.17, 50.30, 48.10, 48.73, 48.25),
  MAE = c(37.96, 40.29, 39.19, 39.39, 39.22)
)

# Melt the data frame for better visualization
results_melted <- reshape2::melt(results_df, id.vars = "Domain")

# Create bar plots for RMSE and MAE
ggplot(results_melted, aes(x = Domain, y = value, fill = variable)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_text(aes(label = round(value, 2)), 
            position = position_dodge(width = 0.9), 
            vjust = -0.5, 
            size = 3) +  # Add text labels above the bars
  labs(title = "RMSE and MAE for Each Domain",
       x = "Domain",
       y = "Value",
       fill = "Metric") +
  theme_minimal() +
  theme(legend.position = "top")
```


# CONCLUSION

In our exploration of the intricate relationship between environmental quality and cancer incidence rates, we set out with two pivotal questions in mind. Firstly, we sought to discern which specific subdomains within the Environmental Quality Index (EQI) dataset held a higher potential for predicting cancer incidence rates. Our systematic analysis unveiled that among the various EQI subdomains, air quality exhibited the most robust predictive power, as indicated by its lowest root mean square error (RMSE) compared to other subdomains. This finding suggests that focusing on air quality may offer valuable insights for policymakers and researchers aiming to develop targeted interventions aimed at reducing cancer instances, thereby optimizing resource allocation and maximizing impact.

Secondly, we delved into the realm of hazardous chemicals or variables within the EQI dataset to ascertain their influence on cancer incidence rates. Through rigorous analysis, we identified specific chemicals such as Cl4C2, Hexane, EtCl, Diesel, and VyCl, which demonstrated notable predictive capabilities with low RMSE values. These findings shed light not only on the predictive power of individual variables but also on societal perceptions of risk. Understanding the disproportionate influence of certain chemicals on cancer rates can inform regulatory priorities and public health campaigns, enabling stakeholders to tailor interventions to address the most pressing concerns effectively.

The implications of these conclusions are far-reaching and carry significant real-world relevance. By leveraging these insights, policymakers and public health officials can prioritize interventions and allocate resources more effectively. For instance, targeted efforts to improve air quality or regulate the use of hazardous chemicals could lead to tangible reductions in cancer rates, ultimately enhancing public health outcomes and quality of life. However, while our study provides valuable insights, there are opportunities for further exploration and refinement. Future research could delve deeper into the mechanisms underlying the observed associations and incorporate additional datasets or advanced statistical techniques to enhance predictive accuracy. By continuing to refine methodologies and explore emerging datasets, we can empower stakeholders with the knowledge and tools needed to make informed decisions and drive positive change in the fight against cancer.


